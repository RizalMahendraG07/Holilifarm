name: Deploy Laravel via Docker

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout kode
        uses: actions/checkout@v3

      - name: Login ke DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build dan push Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/holilifarm-deploy:${{ github.sha }} .
          docker push ${{ secrets.DOCKER_USERNAME }}/holilifarm-deploy:${{ github.sha }}

      - name: Arsipkan file deployment
        run: |
          tar -czf holilifarm.tar.gz docker-compose.yml nginx

      - name: Kirim file ke server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASS }}
          port: 22
          source: "holilifarm.tar.gz"
          target: "/home/${{ secrets.SSH_USER }}/Holilifarm"

      - name: SSH deploy dan jalankan Docker Compose
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASS }}
          port: 22
          script: |
            export IMAGE_TAG=${{ github.sha }}
            export APP_IMAGE=${{ secrets.DOCKER_USERNAME }}/holilifarm-deploy:$IMAGE_TAG

            cd /home/${{ secrets.SSH_USER }}/Holilifarm

            echo "ğŸ§¹ Perbaiki hak akses default.conf jika folder"
            sudo chown -R $USER:$USER nginx || true
            sudo rm -rf nginx/default.conf || true

            echo "ğŸ§¹ Hapus folder nginx lama..."
            sudo rm -rf nginx || true

            echo "ğŸ“¦ Ekstrak file baru..."
            tar -xzf holilifarm.tar.gz
            rm holilifarm.tar.gz

            echo "ğŸ³ Pull image terbaru..."
            docker pull $APP_IMAGE

            echo "ğŸ”§ Generate .env.deploy..."
            echo "APP_IMAGE=$APP_IMAGE" > .env.deploy

            echo "ğŸ§¯ Stop & remove container lama..."
            docker compose --env-file .env.deploy down

            echo "ğŸš€ Jalankan container baru..."
            docker compose --env-file .env.deploy up -d

            echo "â³ Menunggu MySQL siap..."
            sleep 15

            echo "ğŸ“‚ Perizinan direktori Laravel..."
            docker compose --env-file .env.deploy exec app mkdir -p storage/framework/{views,sessions,cache} bootstrap/cache
            docker compose --env-file .env.deploy exec app chmod -R 775 storage bootstrap/cache
            docker compose --env-file .env.deploy exec app chown -R www-data:www-data storage bootstrap/cache

            echo "ğŸ—ƒï¸ Jalankan migrate dan seeder..."
            docker compose --env-file .env.deploy exec app php artisan migrate --force || true
            docker compose --env-file .env.deploy exec app php artisan db:seed --class=UserSeeder --force || true

            echo "âš™ï¸ Clear & cache config/view..."
            docker compose --env-file .env.deploy exec app php artisan config:cache
            docker compose --env-file .env.deploy exec app php artisan view:clear
